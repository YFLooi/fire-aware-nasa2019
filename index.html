<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Data visualiser</title>
    <style>
       /* Set the size of the div element that contains the map */
        #map {
            height: 400px;  /* The height is 400 pixels */
            width: 100%;  /* The width is the width of the web page */
        }
        /*Contains buttons that change the map*/
        #floating-panel {
            /*position: absolute;*/
            margin-top: 10px;
            left: 25%;
            z-index: 0;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }
        
        /* The popup bubble styling. */
        .popup-bubble {
            /* Position the bubble centred-above its parent. */
            position: absolute;
            top: 0;
            left: 0;
            transform: translate(-50%, -100%);
            /* Style the bubble. */
            background-color: white;
            padding: 5px;
            border-radius: 5px;
            font-family: sans-serif;
            overflow-y: auto;
            max-height: 60px;
            box-shadow: 0px 2px 10px 1px rgba(0,0,0,0.5);
        }
        /* The parent of the bubble. A zero-height div at the top of the tip. */
        .popup-bubble-anchor {
            /* Position the div a fixed distance above the tip. */
            position: absolute;
            width: 100%;
            bottom: /* TIP_HEIGHT or the popup box absolute position= */ -37px;
            left: 0;
        }
        /* This element draws the tip. */
        .popup-bubble-anchor::after {
            display: none; /*Hides pointy tips. Can enable later if needed*/
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            /* Center the tip horizontally. */
            transform: translate(-50%, 0);
            /* The tip is a https://css-tricks.com/snippets/css/css-triangle/ */
            width: 0;
            height: 0;
            /* The tip is 8px high, and 12px wide. */
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: /* TIP_HEIGHT= */ 8px solid white;
        }
        /* JavaScript will position this div at the bottom of the popup tip. */
        .popup-container {
            cursor: auto;
            height: 0;
            position: absolute;
            /* The max width of the info window. */
            width: 200px;
        }
    </style>
    <script>
        //Locations. Assume this data is retrieved from a db for a specific time and hour
        const locations = [
            {name: 'SCI', lat: 32.92, lng: -118.49, co2: 411, ch4: 1000, dewptT: -6.25, pressure: 1011, windDir: 158.7, windSpd: 0.79},
            {name: 'CIT', lat: 34.14, lng: -118.13, co2: 435, ch4: 1014, dewptT: 4.0, pressure: 1025, windDir: 320.1, windSpd: 0.01},
            {name: 'IRV', lat: 33.64, lng: -117.84, co2: 480, ch4: 1025, dewptT: 3.12, pressure: 1035, windDir: 50.7, windSpd: 0.21},
            {name: 'GRA', lat: 34.28, lng: -118.47, co2: 422, ch4: 1035, dewptT: -2.27, pressure: 1020, windDir: 180.2, windSpd: 0.56},
            {name: 'LJA', lat: 32.87, lng: -117.25, co2: 415, ch4: 1100, dewptT: 4.13, pressure: 1012, windDir: 90.1, windSpd: 0.87},
        ]

        //'Popup' is a class, popup is a variable
        let map, heatmap, co2Data, ch4Data, popup, Popup;
        //Important regulator to determine if co2 or ch4 data to be used
        let usech4Data = false;
        //First value determines outermost gradient. Must be 'rgba(255, 255, 255, 0)'
        //or the entire map will be coloured
        //4th value in rgba code is 'intensity'. '0' is invisible, '1' is maximum intensity
        //Last value colours the centre. Centre's width increases with weight
        //Gradient set equivalent to CSS 'radial-gradient'
        const co2BrightGradient = [
            'rgba(255, 255, 255, 0.5)',
            'rgba(255, 0, 0, 0.4)',
            'rgba(255, 20, 20, 0.4)',
            'rgba(255, 30, 30, 0.4)',
            'rgba(10, 255, 10, 50)',
            'rgba(0, 255, 0, 50)',
        ]
        const co2DarkGradient = [
            'rgba(255, 255, 255, 0.0)',
            'rgba(255, 0, 0, 0.4)',
            'rgba(255, 20, 20, 0.4)',
            'rgba(255, 30, 30, 0.4)',
            'rgba(10, 255, 10, 50)',
            'rgba(0, 255, 0, 50)',
        ]
        const ch4BrightGradient = [
            'rgba(255, 255, 255, 0.5)',
            'rgba(255, 0, 0, 0.4)',
            'rgba(255, 20, 20, 0.4)',
            'rgba(255, 30, 30, 0.4)',
            'rgba(255, 250, 10, 50)',
            'rgba(255, 250, 0, 50)',
        ]
        const ch4DarkGradient = [
            'rgba(255, 255, 255, 0.0)',
            'rgba(255, 0, 0, 0.4)',
            'rgba(255, 20, 20, 0.4)',
            'rgba(255, 30, 30, 0.4)',
            'rgba(255, 250, 10, 50)',
            'rgba(255, 250, 0, 1)',
        ]

        // On page load, initialize and add the map
        function initMap() {
            //On page load, processes co2 and ch4 data for rendering onto map
            //By default, sends co2Data to map on page load
            //Weight can indicate ppm emissions relative to baseline at SCI: Let weight = ppm at location/ppm @ SCI
            co2Data = []
            //Setup so that weight at SCI (baseline location) = 1
            for(i=0; i<locations.length; i++){
                co2Data[i] = { location: new google.maps.LatLng(locations[i].lat, locations[i].lng), weight: (locations[i].co2/locations[0].co2) }
            }
            ch4Data = []
            //Setup so that weight at SCI (baseline location) = 1
            //(locations[i].co2/locations[0].co2)
            for(i=0; i<locations.length; i++){
                ch4Data[i] = { location: new google.maps.LatLng(locations[i].lat, locations[i].lng), weight: (locations[i].ch4/locations[0].ch4) }
            }

            // The location of centre point. Here, we choose IRV (Irvine, LA)
            var centerCoordinates = {lat: locations[2].lat, lng: locations[2].lng};
            // The map, centered at at the coordinates in 'var centre'
            //mapTypeId determines the type of map on render. Can be 'roadmap', 'satellite', or 'terrain'
            map = new google.maps.Map(
                document.getElementById('map'), {zoom: 7.75, center: centerCoordinates, mapTypeId: 'terrain'});
            // for loop to generate all the markers for sensor position
            for (i=0; i<5; i++){
                let marker = new google.maps.Marker({
                    position: {lat: locations[i].lat, lng: locations[i].lng}, 
                    map: map,
                    title: locations[i].name
                })
                marker.addListener('mouseover', function() {
                    infowindow.open(map, marker);
                });
            }
            //Each element tag should be wrapped in '' and ended with '+'. 
            //Attribute text wrapped in "". 
            var contentString = '<div id="content" style="background-color: green; width:40px; height: 40px;">'+ 
                '<b>Test</b>'+    
            '</div>';
            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });
            
            //For indicating elevation
            var elevator = new google.maps.ElevationService;
            //Renders the popup window indicating metres of elevation
            var infowindow = new google.maps.InfoWindow({map: map});
            // Add a listener click event on 'var map'. Display the elevation for the LatLng of
            // the click inside the infowindow.
            map.addListener('click', function(event) {
                displayLocationElevation(event.latLng, elevator, infowindow);
            });

            //Settings for the heatmap. It is rendered as a layer above the base map stored in 'var map'
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: selectHeatmapData(),
                map: map,
                gradient: co2BrightGradient,
                radius: 40,
            });

            //Renders a popup for each location
            for (i=0; i<locations.length; i++){
                //Renders the <div>-s containing content for reach popup
                //This hijacks the original code that needs a pre-defined <div> containing the popup's content
                const popupContentTarget = document.getElementById('popup-content');
                let popupContent = document.createElement('div');
                popupContent.setAttribute('id','popup-content.'+i); 
                usech4Data === true ? popupContent.innerHTML = `${locations[i].ch4} ppb` : popupContent.innerHTML = `${locations[i].co2} ppm`;
                popupContentTarget.appendChild(popupContent)

                Popup = createPopupClass();
                //Passes location and content for popup to Popup();
                //The 'content' property takes the entire DOM obtained by document.getElementById
                popup = new Popup(
                    new google.maps.LatLng(locations[i].lat, locations[i].lng),
                    document.getElementById('popup-content.'+i));
                popup.setMap(map);
            }
        }
        function displayLocationElevation(location, elevator, infowindow) {
            // Initiate the location request
            elevator.getElevationForLocations({
                'locations': [location]
            }, function(results, status) {
                infowindow.setPosition(location);
                if (status === 'OK') {
                    // Retrieve the first result
                    if (results[0]) {
                    // Open the infowindow indicating the elevation at the clicked position.
                    infowindow.setContent('The elevation at this point <br>is ' +
                        results[0].elevation.toFixed(0) + ' meters.');
                    } else {
                    infowindow.setContent('No results found');
                    }
                } else {
                    infowindow.setContent('Elevation service failed due to: ' + status);
                }
            });
        }
        function selectHeatmapData () {
            if(usech4Data === false){
                return co2Data;
            } else if(usech4Data === true){
                return ch4Data
            }
        }
        
        //createPopupClass() Returns the Popup class.
        //Unfortunately, the Popup class can only be defined after
        //google.maps.OverlayView is defined, when the Maps API is loaded.
        //This function should only be called by initMap.
        function createPopupClass() {
            //A customized popup on the map.
            //@param {!google.maps.LatLng} position
            //@param {!Element} content The bubble div.
            //@constructor
            //@extends {google.maps.OverlayView}
        
            function Popup(position, content) {
                this.position = position;

                content.classList.add('popup-bubble');

                // This zero-height div is positioned at the bottom of the bubble.
                var bubbleAnchor = document.createElement('div');
                bubbleAnchor.classList.add('popup-bubble-anchor');
                bubbleAnchor.appendChild(content);

                // This zero-height div is positioned at the bottom of the tip.
                this.containerDiv = document.createElement('div');
                this.containerDiv.classList.add('popup-container');
                this.containerDiv.appendChild(bubbleAnchor);

                // Optionally stop clicks, etc., from bubbling up to the map.
                google.maps.OverlayView.preventMapHitsAndGesturesFrom(this.containerDiv);
            }
            // ES5 magic to extend google.maps.OverlayView.
            Popup.prototype = Object.create(google.maps.OverlayView.prototype);

            /** Called when the popup is added to the map. */
            Popup.prototype.onAdd = function() {
                this.getPanes().floatPane.appendChild(this.containerDiv);
            };

            /** Called when the popup is removed from the map. */
            Popup.prototype.onRemove = function() {
                if (this.containerDiv.parentElement) {
                    this.containerDiv.parentElement.removeChild(this.containerDiv);
                }
            };

            /** Called each frame when the popup needs to draw itself. */
            Popup.prototype.draw = function() {
                var divPosition = this.getProjection().fromLatLngToDivPixel(this.position);

                // Hide the popup when it is far out of view.
                var display =
                    Math.abs(divPosition.x) < 4000 && Math.abs(divPosition.y) < 4000 ?
                    'block' :
                    'none';

                if (display === 'block') {
                    this.containerDiv.style.left = divPosition.x + 'px';
                    this.containerDiv.style.top = divPosition.y + 'px';
                }
                if (this.containerDiv.style.display !== display) {
                    this.containerDiv.style.display = display;
                }
            };

            return Popup;
        }

        //These functions alter the heatmap
        //Turns the heatmap on/off
        function toggleHeatmap() {
            heatmap.setMap(heatmap.getMap() ? null : map);
        }
        //Toggles the gradient between red-yellow-green to red-cyan-purple
        function changeGradient() {
            let targetGradient = [];
            if(heatmap.get('gradient') === co2BrightGradient && usech4Data === false){
                targetGradient = co2DarkGradient
            } else if(heatmap.get('gradient') === co2DarkGradient && usech4Data === false){
                targetGradient = co2BrightGradient
            //Will only work if ch4BrightGradient applied if data source switched to ch4Data
            } else if(heatmap.get('gradient') === ch4BrightGradient && usech4Data === true){
                targetGradient = ch4DarkGradient
            } else if(heatmap.get('gradient') === ch4DarkGradient && usech4Data === true){
                targetGradient = ch4BrightGradient
            }

            heatmap.set('gradient', targetGradient);
        }
        //Sets radius of heatmap relative to each coordinate in heatmap
        function changeRadius() {
            heatmap.set('radius', heatmap.get('radius') ===  40 ? 60 : 40);
        }
        //Changes the intensity of the heatmap's colours
        function changeOpacity() {
            heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
        }
        //Changes which GHG's data is displayed
        function changeGHG(){
            usech4Data === false ? (usech4Data = true) : (usech4Data = false); 
            
            //Cannot use heatmap.set to swap 'data' property of rendered heatmap
            //or it will log TypeErrors in console.
            //Need to re-render Map if 'data' property changed
            initMap()

            //Sets the gradient for the resulting Map
            if (usech4Data === false){
                heatmap.set('gradient', co2BrightGradient)
            } else if (usech4Data === true){
                heatmap.set('gradient', ch4BrightGradient)
            }
        }
    </script>
    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->
    <!--src to call API using assigned key: src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&CALL-STUFF-HERE" -->
    <!--'&callback=initMap' passes the calls to the Maps API made with initMap() on page load-->
    <!--'&libraries=visualization' Loads up google.maps.visualisation library for heatmaps-->
    <script type="text/javascript" async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCl6RtMrpOskELXpQocWoOqZxf_qT2y69M&callback=initMap&libraries=visualization">
    </script>    
  </head>
  <body>
    <h3>My Google Maps Demo</h3>
    <!--The div element for the map -->
   
    <div id="map"></div>
    <!--Serves as target to render <div>-s containing labels for popups-->
    <div id='popup-content'></div>
    
    <div id="floating-panel">
        <button onclick="changeGHG()">CO2/CH4 toggle</button>
        <!--Recentres the viewport and clears all changes by re-rendering the onload map-->
        <button onclick="initMap()">Reset map</button> 
        <button onclick="toggleHeatmap()">Heatmap on/off</button>
        <button onclick="changeGradient()">Darken background</button>
        <button onclick="changeRadius()">Change radius</button>
        <button onclick="changeOpacity()">Change opacity</button>
    </div>
    <p></p>
    <div>
        <p>
            Radius and intensity of CO2 (
            <span style='display:inline-block; width:10px; height: 10px; background-color:rgba(0, 255, 0, 1);'></span>
            ) and CH4 (
            <span style='display:inline-block; width:10px; height: 10px; background-color:rgb(255, 250, 0);'></span>
            ) increases with CO2 and CH4 concentration above baseline
        </p>
        <p>
            Baseline (zero emissions): CO2 and CH4 readings at San Clemente Island (SCI) 
        </p>
        <p>
            Click on map to show local elevation. Click on markers to display additional data for each location
        </p>
    </div>
    <p></p>
    <div>Gradient palette   
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(255, 255, 255, 0);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 191, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 127, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px;background-color:rgba(0, 63, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 0, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 0, 127, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(63, 0, 91, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(127, 0, 63, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(255, 9, 9, 0.973);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgb(255, 214, 214);'>1</div>

        <div style='float: left; width: 20px; height: 20px; background-color:rgb(255, 251, 0);'>1</div>
    </div>
  </body>
</html>