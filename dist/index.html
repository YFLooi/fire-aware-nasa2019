<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Greenhouse gas emission visualiser</title>

     <!-- The core Firebase JS SDK is always required and must be listed first -->
     <!-- Original end of this url is 'firebase-app.js'. This does not work!! Use firebase.js instead-->
     <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase.js"></script>

     <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
 
     <script>
       // Your web app's Firebase configuration
       var firebaseConfig = {
         apiKey: "AIzaSyAplfPUP0ygPtbSQYWEG6cr2vlAl6misvw",
         authDomain: "nasa2019-a41ab.firebaseapp.com",
         databaseURL: "https://nasa2019-a41ab.firebaseio.com",
         projectId: "nasa2019-a41ab",
         storageBucket: "nasa2019-a41ab.appspot.com",
         messagingSenderId: "947284643043",
         appId: "1:947284643043:web:04f306d3ff8556dbde49d6"
       };
       // Initialize Firebase
       firebase.initializeApp(firebaseConfig);
     </script>


    <link rel="stylesheet" href="./css/mapStyles.css">
   
    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->
    <!--src to call API using assigned key: src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&CALL-STUFF-HERE" -->
    <!--'&callback=initMap' passes the calls to the Maps API made with initMap() on page load. Wait, does not work when page 
    loaded from Express backend?-->
    <!--'&libraries=visualization' Loads up google.maps.visualisation library for heatmaps-->
    <script type="text/javascript" async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCl6RtMrpOskELXpQocWoOqZxf_qT2y69M&libraries=visualization">
    </script>   
    <!--Scripts to operate Google Maps API-->
    <script type="text/javascript" src='./js/map.js'></script> 
    <script type="text/javascript" src="./js/bundle.js"></script>
    <!--Scripts to operate Canvas.js maps-->
    <script type="text/javascript" src="./canvas/canvasjs.min.js"></script>
    <script type="text/javascript" src="./js/chart.js"></script>
    <script type='text/javascript'>
      window.onload = function () {
        //Sets all checkboxes for chart element to 'checked' on page load
        //This prevents data from being already displayed but boxes being unchecked
        //which happens when chart first loads with pre-set data
        let chartElementToggle = document.getElementsByName('chartElement');
        for(let i=0; i<chartElementToggle.length; i++){
          chartElementToggle[i].checked = true
        }

        const database = firebase.database();
        function onloadRender(){
          database.ref('modis/1Sep2019').once('value', (snapshot) => {
            //Gets object attached to 'snapshot'            
            const data = snapshot.val()
            console.log(data)
            //console.log(Object.keys(data).length);

            if(data === null || data.length === 0){
              document.getElementById('map').innerHTML = 'No data found for selected date';
              console.log('Error retrieving data from Firebase db')
            } else {
              const dataArray = Object.values(data);
              console.log(dataArray)
              runInitMap(dataArray);
            }
          })
        }

        onloadRender();
        renderChart();
      }
    </script>
  </head>

  <body>
    <div class='header' style="background-color: black; color: white; padding: 10px; margin-bottom: 10px;">
      <h2>Air pollutant emission visualiser</h2>
    </div>
    <!--The div element for the map -->
    <div id='mapContainer'>
      <div id="map"></div>  
    </div>
    <!--Serves as target to render <div>-s containing labels for popups-->
    <div id='popup-content'></div>
    
    <div id='dateSelect' style="margin:10px;">
      <h4>Select date:</h4>
      <form name='dateForData' onsubmit='event.preventDefault(); changeMapData(this)'> 
        <span>
          <select name='dayInput'>
            <option value='1' selected>1</option>
            <option value='2'>2</option>
            <option value='3'>3</option>
            <option value='4'>4</option>
            <option value='5'>5</option>
            <option value='6'>6</option>
            <option value='7'>7</option>
            <option value='8'>8</option>
            <option value='9'>9</option>
            <option value='10'>10</option>
            <option value='11'>11</option>
            <option value='12'>12</option>
            <option value='13'>13</option>
            <option value='14'>14</option>
            <option value='15'>15</option>
            <option value='16'>16</option>
            <option value='17'>17</option>
            <option value='18'>18</option>
            <option value='19'>19</option>
            <option value='20'>20</option>
            <option value='21'>21</option>
            <option value='22'>22</option>
            <option value='23'>23</option>
            <option value='24'>24</option>
            <option value='25'>25</option>
            <option value='26'>26</option>
            <option value='27'>27</option>
            <option value='28'>28</option>
            <option value='29'>29</option>
            <option value='30'>30</option>
            <option value='31'>31</option>
          </select>
          <select name='monthInput'>
              <option value='Jan'>Jan</option>
              <option value='Feb'>Feb</option>
              <option value='Mar'>Mar</option>
              <option value='Apr'>Apr</option>
              <option value='May'>May</option>
              <option value='Jun'>Jun</option>
              <option value='Jul'>Jul</option>
              <option value='Aug'>Aug</option>
              <option value='Sep' selected>Sep</option>
              <option value='Oct'>Oct</option>
              <option value='Nov'>Nov</option>
              <option value='Dec'>Dec</option>
          </select>
          <select name='yearInput'>
              <option value='2018'>2018</option>
              <option value='2019' selected>2019</option>
          </select>
          <input type='submit' value="&#8981;" onclick="event.keyCode === 13"/>
        </span>
      </form>
    </div>
    <div id="floating-panel">
        <div>
            <button type='button' class='btn btn-primary' onclick="changeDataDisplayed('power')">Thermal anomalies</button>
            <button type='button' class='btn btn-primary' onclick="changeDataDisplayed('confidence')">Confidence</button>
        </div>  
        <div>
          <!--Recentres the viewport and clears all changes by re-rendering the onload map-->
          <button type='button' class='btn btn-secondary' onclick="initMap()">Reset map</button> 
          <button type='button' class='btn btn-secondary' onclick="toggleHeatmap()">Heatmap on/off</button>
          <button type='button' class='btn btn-secondary' onclick="changeGradient()">Darken background</button>
          <button type='button' class='btn btn-secondary' onclick="changeRadius()">Change radius</button>
          <button type='button' class='btn btn-secondary' onclick="changeOpacity()">Change opacity</button>
        </div>
    </div>
    <p></p>
    <div>
        <p>
            Radius and intensity of heatmap center increases with pollutant above baseline 
        </p>
        <p>
            Click on markers to display additional data for each location
        </p>
    </div>
    <p></p>
    <!--Canvas.js chart-->
    <div id="chartContainer" style="height: 300px; width: 100%;"></div>
    <div id="floating-panel">
        <button type='button' class='btn btn-secondary' onclick="updateChart()">Update chart data</button><br>
        <input type="checkbox" name="chartElement" value='CO2 (ppm)' checked onclick='toggleChartElements(0)'> Show CO2 &nbsp;
        <input type="checkbox" name="chartElement" value='CH4 (ppb)' checked onclick='toggleChartElements(1)'> Show CH4 &nbsp;
        <input type="checkbox" name="chartElement" value='T ambient (Â°C)' checked onclick='toggleChartElements(2)'> Show ambient temperature 
    </div>
    <p></p>
    <div>Gradient palette   
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(255, 255, 255, 0);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 191, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 127, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px;background-color:rgba(0, 63, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 0, 255, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(0, 0, 127, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(63, 0, 91, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(127, 0, 63, 1);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgba(255, 9, 9, 0.973);'>1</div>
        <div style='float: left; width: 20px; height: 20px; background-color:rgb(255, 214, 214);'>1</div>

        <div style='float: left; width: 20px; height: 20px; background-color:rgb(255, 251, 0);'>1</div>
    </div>
    
   
  </body>
</html>